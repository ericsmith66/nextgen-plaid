<div class="container" style="padding: 24px;">
  <h1>Mission Control</h1>

  <div style="margin: 16px 0;">
    <%= button_to "Nuke Everything", 
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  mission_control_nuke_path,
                  method: :post,
                  form: { style: "display:inline-block; margin-right:8px;" , data: { turbo_confirm: "Are you sure? This deletes all Plaid data (items, accounts, holdings)." } },
                  class: "btn" %>

    <%= button_to "Sync Holdings Now",
                  mission_control_sync_holdings_now_path,
                  method: :post,
                  form: { style: "display:inline-block; margin-right:8px;" },
                  class: "btn" %>

    <%= button_to "Sync Transactions Now",
                  mission_control_sync_transactions_now_path,
                  method: :post,
                  form: { style: "display:inline-block; margin-right:8px;" },
                  class: "btn" %>

    <%= button_to "Sync Liabilities Now",
                  mission_control_sync_liabilities_now_path,
                  method: :post,
                  form: { style: "display:inline-block; margin-right:8px;" },
                  class: "btn" %>

    <%= button_to "Refresh Everything Now",
                  mission_control_refresh_everything_now_path,
                  method: :post,
                  form: { style: "display:inline-block;" },
                  class: "btn",
                  style: "background:#28a745; color:white; font-weight:bold;" %>
  </div>

  <% # PRD 6.4: Global "Items needing attention" section %>
  <% needs_reauth_items = @plaid_items.select { |item| item.status == 'needs_reauth' || item.status == 'failed' } %>
  <% if needs_reauth_items.any? %>
    <div style="margin: 24px 0; padding: 16px; border: 2px solid #dc3545; border-radius: 8px; background: #f8d7da;">
      <h2 style="margin: 0 0 12px 0; color: #721c24;">
        ‚ö†Ô∏è Items Needing Attention
        <span style="display: inline-block; background: #dc3545; color: white; padding: 2px 8px; border-radius: 12px; font-size: 14px; margin-left: 8px;">
          <%= needs_reauth_items.size %>
        </span>
      </h2>
      <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%; background: white;">
        <thead>
          <tr>
            <th>Institution</th>
            <th>Status</th>
            <th>Error</th>
            <th>Attempts</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <% needs_reauth_items.each do |item| %>
            <tr>
              <td><%= item.institution_name %></td>
              <td>
                <span style="color: #dc3545; font-weight: bold;"><%= item.status %></span>
              </td>
              <td><%= item.last_error&.truncate(80) || '-' %></td>
              <td><%= item.reauth_attempts %> / 3</td>
              <td>
                <% if item.status == 'needs_reauth' %>
                  <button type="button" class="btn" onclick="relinkItem(<%= item.id %>)" style="background: #ffc107; color: #000;">Re-link</button>
                <% else %>
                  <span style="color: #6c757d;">Failed (max attempts)</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>

  <% if @plaid_items.any? %>
    <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%;">
      <thead>
        <tr>
          <th>Institution</th>
          <th>Item ID</th>
          <th>Status</th>
          <th>Holdings Synced</th>
          <th>Transactions Synced</th>
          <th>Liabilities Synced</th>
          <th># Accounts</th>
          <th># Holdings</th>
          <th># Transactions</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @plaid_items.each do |item| %>
          <tr>
            <td><%= item.institution_name %></td>
            <td><%= item.item_id %></td>
            <td>
              <% color = (item.status == 'good') ? 'green' : 'red' %>
              <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:<%= color %>;"></span>
              <span style="margin-left:6px;"><%= item.status %></span>
            </td>
            <td>
              <% if item.holdings_synced_at.present? %>
                <%= time_ago_in_words(item.holdings_synced_at) %> ago
                (<%= item.holdings_synced_at.strftime('%Y-%m-%d %H:%M') %>)
              <% else %>
                -
              <% end %>
            </td>
            <td>
              <% if item.transactions_synced_at.present? %>
                <%= time_ago_in_words(item.transactions_synced_at) %> ago
                (<%= item.transactions_synced_at.strftime('%Y-%m-%d %H:%M') %>)
              <% else %>
                -
              <% end %>
            </td>
            <td>
              <% if item.liabilities_synced_at.present? %>
                <%= time_ago_in_words(item.liabilities_synced_at) %> ago
                (<%= item.liabilities_synced_at.strftime('%Y-%m-%d %H:%M') %>)
              <% else %>
                -
              <% end %>
            </td>
            <td><%= item.accounts.size %></td>
            <td><%= item.holdings.size %></td>
            <td><%= Transaction.joins(account: :plaid_item).where(plaid_items: { id: item.id }).count %></td>
            <td>
              <% # PRD 6.2: Re-link button visible only for needs_reauth items %>
              <% if item.status == 'needs_reauth' %>
                <button type="button" class="btn" data-item-id="<%= item.id %>" onclick="relinkItem(<%= item.id %>)">Re-link</button>
              <% elsif item.status == 'failed' %>
                <span style="color: #dc3545;">Max attempts reached</span>
              <% else %>
                -
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <div style="margin-top:12px; padding:16px; border:1px dashed #bbb; border-radius:6px; background:#fafafa; color:#333;">
      <strong>No Plaid items yet.</strong>
      <div style="margin-top:6px;">
        Connect an account via the customer dashboard‚Äôs Plaid Link flow. After linking, return here to sync holdings and see real‚Äëtime logs.
      </div>
    </div>
  <% end %>

  <div style="margin-top:24px;">
    <h2>Recent Syncs</h2>
    <div id="sync-log" style="font-style: italic; color: #111; background:#fff; border:1px solid #ddd; padding:12px; border-radius:6px;">Loading logs‚Ä¶</div>
  </div>

  <div style="margin-top:24px;">
    <h2>Recent Transactions (Last 20)</h2>
    <% if @transactions.any? %>
      <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%;">
        <thead>
          <tr>
            <th>Logo</th>
            <th>Date</th>
            <th>Merchant</th>
            <th>Amount</th>
            <th>Category (Enriched)</th>
            <th>Confidence</th>
            <th>Account</th>
            <th>Pending</th>
          </tr>
        </thead>
        <tbody>
          <% @transactions.each do |txn| %>
            <% enriched = txn.enriched_transaction %>
            <tr>
              <td style="text-align:center;">
                <% if enriched&.use_enriched_data? && enriched.logo_url.present? %>
                  <img src="<%= enriched.logo_url %>" alt="logo" style="width:32px; height:32px; border-radius:4px; object-fit:contain; background:white; padding:3px;">
                <% else %>
                  üí≥
                <% end %>
              </td>
              <td><%= txn.date %></td>
              <td>
                <% if enriched&.use_enriched_data? %>
                  <strong><%= enriched.merchant_name %></strong>
                <% else %>
                  <%= txn.name %> <span style="color:#999; font-size:12px;">(unverified)</span>
                <% end %>
              </td>
              <td style="color:<%= txn.amount < 0 ? 'green' : 'red' %>;">
                <%= number_to_currency(txn.amount) if txn.amount %>
              </td>
              <td>
                <% if enriched&.personal_finance_category.present? %>
                  <span style="background:#3b82f6; color:white; padding:3px 8px; border-radius:8px; font-size:11px;">
                    <%= enriched.personal_finance_category %>
                  </span>
                <% else %>
                  <%= txn.category %>
                <% end %>
              </td>
              <td>
                <% if enriched&.confidence_level.present? && !enriched.low_confidence? %>
                  <% confidence_color = case enriched.confidence_level
                       when "VERY_HIGH", "HIGH" then "green"
                       when "MEDIUM" then "orange"
                       else "red"
                       end %>
                  <span style="color:<%= confidence_color %>; font-weight:bold; font-size:11px;">
                    <%= enriched.confidence_level.humanize %>
                  </span>
                <% else %>
                  <span style="color:#999; font-size:11px;">Low</span>
                <% end %>
              </td>
              <td><%= txn.account&.name || txn.account&.account_id %></td>
              <td><%= txn.pending ? 'Yes' : 'No' %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div style="padding:12px; border:1px dashed #bbb; border-radius:6px; background:#fafafa; color:#333;">
        No transactions yet. Click "Sync Transactions Now" to fetch data.
      </div>
    <% end %>
  </div>

  <div style="margin-top:24px;">
    <h2>Recurring Transactions</h2>
    <% if @recurring_transactions.any? %>
      <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%;">
        <thead>
          <tr>
            <th>Stream ID</th>
            <th>Description</th>
            <th>Avg Amount</th>
            <th>Frequency</th>
            <th>Type</th>
            <th>Institution</th>
          </tr>
        </thead>
        <tbody>
          <% @recurring_transactions.each do |rt| %>
            <tr>
              <td><%= rt.stream_id %></td>
              <td><%= rt.description %></td>
              <td><%= number_to_currency(rt.average_amount) if rt.average_amount %></td>
              <td><%= rt.frequency %></td>
              <td><%= rt.stream_type %></td>
              <td><%= rt.plaid_item&.institution_name %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div style="padding:12px; border:1px dashed #bbb; border-radius:6px; background:#fafafa; color:#333;">
        No recurring transactions yet. Click "Sync Transactions Now" to fetch data.
      </div>
    <% end %>
  </div>

  <div style="margin-top:24px;">
    <h2>Accounts</h2>
    <% if @accounts.any? %>
      <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%;">
        <thead>
          <tr>
            <th>Account ID</th>
            <th>Name</th>
            <th>Type</th>
            <th>Subtype</th>
            <th>Mask</th>
            <th>Current Balance</th>
            <th>Currency</th>
            <th>Institution</th>
            <th># Holdings</th>
            <th># Transactions</th>
          </tr>
        </thead>
        <tbody>
          <% @accounts.each do |account| %>
            <tr>
              <td><%= account.account_id %></td>
              <td><%= account.name %></td>
              <td><%= account.type %></td>
              <td><%= account.subtype %></td>
              <td><%= account.mask %></td>
              <td><%= number_to_currency(account.current_balance) if account.current_balance %></td>
              <td><%= account.iso_currency_code %></td>
              <td><%= account.plaid_item&.institution_name %></td>
              <td><%= account.holdings.count %></td>
              <td><%= account.transactions.count %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div style="padding:12px; border:1px dashed #bbb; border-radius:6px; background:#fafafa; color:#333;">
        No accounts yet. Link a Plaid item and sync holdings to see accounts.
      </div>
    <% end %>
  </div>

  <div style="margin-top:24px;">
    <h2>Holdings</h2>
    <% if @holdings.any? %>
      <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%;">
        <thead>
          <tr>
            <th>Security ID</th>
            <th>Symbol</th>
            <th>Name</th>
            <th>Quantity</th>
            <th>Cost Basis</th>
            <th>Market Value</th>
            <th>Account</th>
            <th>Institution</th>
          </tr>
        </thead>
        <tbody>
          <% @holdings.each do |holding| %>
            <tr>
              <td><%= holding.security_id %></td>
              <td><%= holding.symbol %></td>
              <td><%= holding.name %></td>
              <td><%= holding.quantity %></td>
              <td><%= number_to_currency(holding.cost_basis) if holding.cost_basis %></td>
              <td><%= number_to_currency(holding.market_value) if holding.market_value %></td>
              <td><%= holding.account&.name || holding.account&.account_id %></td>
              <td><%= holding.account&.plaid_item&.institution_name %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div style="padding:12px; border:1px dashed #bbb; border-radius:6px; background:#fafafa; color:#333;">
        No holdings yet. Link a Plaid item and sync holdings to see holdings.
      </div>
    <% end %>
  </div>

  <div style="margin-top:24px;">
    <h2>Liabilities (PRD 12: Data on Account Model)</h2>
    <% liability_accounts = @accounts.select { |a| a.apr_percentage.present? || a.min_payment_amount.present? } %>
    <% if liability_accounts.any? %>
      <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%;">
        <thead>
          <tr>
            <th>Account</th>
            <th>Min Payment</th>
            <th>APR %</th>
            <th>Due Date</th>
            <th>Overdue?</th>
            <th>Debt Risk?</th>
            <th>Institution</th>
          </tr>
        </thead>
        <tbody>
          <% liability_accounts.each do |account| %>
            <tr>
              <td><%= account.name || account.account_id %></td>
              <td><%= number_to_currency(account.min_payment_amount) if account.min_payment_amount %></td>
              <td><%= account.apr_percentage ? "#{account.apr_percentage}%" : '-' %></td>
              <td><%= account.next_payment_due_date || '-' %></td>
              <td><%= account.is_overdue ? '‚ö†Ô∏è YES' : 'No' %></td>
              <td><%= account.debt_risk_flag ? 'üö® HIGH' : 'Normal' %></td>
              <td><%= account.plaid_item&.institution_name %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div style="padding:12px; border:1px dashed #bbb; border-radius:6px; background:#fafafa; color:#333;">
        No liabilities yet. Click "Sync Liabilities Now" to fetch credit card, loan, and mortgage data.
      </div>
    <% end %>
  </div>
</div>

<!-- Simple toast -->
<div id="mc-toast" style="position:fixed; right:16px; bottom:16px; background:#333; color:#fff; padding:12px 14px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.25); z-index:9999; display:none; max-width:70vw;">
  <span id="mc-toast-text">Done</span>
  <button onclick="hideToast()" style="margin-left:12px; background:transparent; color:#fff; border:0; cursor:pointer;">‚úï</button>
  <div style="font-size:11px; opacity:0.8; margin-top:4px;">This message will auto-dismiss</div>
  </div>

<!-- Plaid Link JS -->
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
  function csrfToken() {
    var meta = document.querySelector('meta[name="csrf-token"]');
    return meta && meta.getAttribute('content');
  }

  // Toast helpers
  let toastTimer = null;
  function showToast(message) {
    const box = document.getElementById('mc-toast');
    const txt = document.getElementById('mc-toast-text');
    if (!box || !txt) return;
    txt.textContent = message;
    box.style.display = 'block';
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(hideToast, 4500);
  }
  function hideToast() {
    const box = document.getElementById('mc-toast');
    if (box) box.style.display = 'none';
  }

  async function relinkItem(id) {
    try {
      const res = await fetch('<%= mission_control_relink_path(id: "__ID__") %>'.replace('__ID__', id), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken()
        },
        body: JSON.stringify({})
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert('Failed to get link token: ' + (err.error || res.statusText));
        return;
      }
      const data = await res.json();
      const handler = Plaid.create({
        token: data.link_token,
        onSuccess: async function(public_token, metadata) {
          // After update-mode success, trigger a holdings sync server-side, then reload
          try {
            await fetch('<%= mission_control_relink_success_path(id: "__ID__") %>'.replace('__ID__', id), {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken()
              },
              body: JSON.stringify({ public_token: public_token })
            });
            // Mark expectation for a holdings sync completion toast
            try { localStorage.setItem('mc_expect_holdings_toast', '1'); } catch(e) {}
          } catch (e) {
            console.warn('Failed to notify relink success:', e);
          }
          window.location.reload();
        },
        onExit: function(err, metadata) {
          if (err) {
            console.warn('Plaid Link exit:', err);
          }
        }
      });
      handler.open();
    } catch (e) {
      alert('Error: ' + (e && e.message ? e.message : e));
    }
  }

  // Logs auto-refresh placeholder (endpoint will be added next)
  async function refreshLogs() {
    try {
      const res = await fetch('<%= url_for(controller: :mission_control, action: :logs, format: :json) rescue '#'%>');
      if (!res || !res.ok) return;
      const logs = await res.json();
      const el = document.getElementById('sync-log');
      if (!Array.isArray(logs) || logs.length === 0) {
        el.textContent = 'No recent logs yet.';
        return;
      }
      el.style.fontStyle = 'normal';
      el.style.color = '#111';
      el.innerHTML = logs.map(function(l){
        var statusColor = l.status === 'success' ? 'green' : (l.status === 'started' ? 'gray' : 'red');
        var msg = '[' + l.created_at + '] ' + l.job_type + ' ‚Äî ' + l.status;
        if (l.job_id) { msg += ' (#' + l.job_id + ')'; }
        if (l.error_message) { msg += ' ‚Äî ' + l.error_message; }
        return '<div><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:'+statusColor+';margin-right:6px;"></span>' + msg + '</div>';
      }).join('');

      // Show a one-time toast when a new success arrives since the last seen log
      try {
        var lastSeenId = localStorage.getItem('mc_last_seen_log_id');
        if (!lastSeenId && logs.length > 0) {
          // Initialize on first load to avoid toasting historical logs
          localStorage.setItem('mc_last_seen_log_id', String(logs[0].id));
          return;
        }
        if (logs.length > 0 && String(logs[0].id) !== String(lastSeenId)) {
          // Find any new success logs among the new entries (up to the previous lastSeen)
          const cutoffId = lastSeenId;
          const newlySeen = [];
          for (var i = 0; i < logs.length; i++) {
            var entry = logs[i];
            if (String(entry.id) === String(cutoffId)) break;
            if (entry.status === 'success') newlySeen.push(entry);
          }
          if (newlySeen.length > 0) {
            const expectToast = localStorage.getItem('mc_expect_holdings_toast') === '1';
            // Prefer a holdings-specific message if we just re-linked, else general message
            const first = newlySeen[0];
            if (expectToast) {
              showToast('Holdings sync finished for ' + (first.institution_name || ('item #' + first.plaid_item_id)) + '.');
              localStorage.removeItem('mc_expect_holdings_toast');
            } else {
              showToast('Sync finished: ' + first.job_type + (first.institution_name ? (' ‚Äî ' + first.institution_name) : ''));
            }
          }
          localStorage.setItem('mc_last_seen_log_id', String(logs[0].id));
        }
      } catch(e) { /* ignore */ }
    } catch (e) {
      // noop
    }
  }
  setInterval(refreshLogs, 5000);
  document.addEventListener('DOMContentLoaded', refreshLogs);
</script>
