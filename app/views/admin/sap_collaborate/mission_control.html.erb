<div class="min-h-screen bg-base-200" data-controller="chat" data-action="turbo:frame-load->chat#scroll" data-chat-poll-url="<%= admin_sap_mission_control_status_path(correlation_id: @correlation_id) %>" data-chat-sse-url="" data-chat-correlation-id="<%= @correlation_id %>">
  <div class="flex flex-col h-screen">
    <header class="navbar bg-base-100 shadow-sm px-4 sticky top-0 z-10">
      <div class="flex-1">
        <h1 class="text-xl font-semibold">SAP Mission Control</h1>
      </div>
      <div class="flex-none">
        <div class="dropdown dropdown-end">
          <label tabindex="0" class="btn btn-ghost btn-circle">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-6 h-6 stroke-current">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6a2 2 0 110-4 2 2 0 010 4zm0 8a2 2 0 110-4 2 2 0 010 4zm0 8a2 2 0 110-4 2 2 0 010 4z" />
            </svg>
          </label>
          <div tabindex="0" class="dropdown-content z-[1] menu p-4 shadow bg-base-100 rounded-box w-64">
            <p class="text-sm text-base-content/70">Controls coming soon.</p>
          </div>
        </div>
      </div>
    </header>

    <div class="alert alert-info rounded-none" data-chat-target="indicator">
      Polling every 3s...
    </div>

    <main class="flex-1 overflow-hidden">
      <div class="chat flex flex-col-reverse h-full overflow-y-auto px-4 gap-4" id="chat-stream" data-chat-target="stream" role="log" aria-live="polite" style="padding-bottom: var(--chat-footer-height, 7rem);">
        <%= render BubbleComponent.new(type: :system, title: "Welcome", body: "Start a task to see live updates.") %>
        <%= render BubbleComponent.new(type: :agent, title: "Agent", body: "Responses will appear here.") %>
        <%= render BubbleComponent.new(type: :phase, title: "Phase", body: "Phases will appear as badges as the run progresses.") %>
        <%= render BubbleComponent.new(type: :token, title: "Tokens", body: "Token usage badges will show used/remaining.") %>
      </div>
    </main>

    <footer class="fixed bottom-0 left-0 right-0 bg-base-100 shadow-lg p-4" id="chat-footer" data-chat-target="footer">
      <%= form_with url: admin_sap_mission_control_start_iterate_path, method: :post, html: { class: "w-full", data: { action: "submit->chat#submitForm" } } do |f| %>
        <%= hidden_field_tag :correlation_id, @correlation_id %>
        <%= hidden_field_tag :idempotency_uuid, @idempotency_uuid %>
        <div class="join w-full">
          <%= f.text_area :task, value: @task, required: true, class: "textarea textarea-bordered join-item w-full resize-none", placeholder: "Describe the task (e.g., Generate PRD for webhook ingestion)" %>
          <button class="btn btn-primary join-item" type="submit">Send</button>
        </div>
        <div class="mt-2 flex flex-wrap items-center justify-between text-xs text-base-content/60 gap-2">
          <span>Correlation: <span class="font-mono"><%= @correlation_id %></span></span>
          <span>Idempotency: <span class="font-mono"><%= @idempotency_uuid %></span></span>
        </div>
      <% end %>
    </footer>
  </div>
</div>