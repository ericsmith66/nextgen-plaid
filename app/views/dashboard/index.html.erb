<%= render(LayoutComponent.new(title: "Dashboard", current_user: current_user)) do %>
  <%= render(DashboardComponent.new(current_user: current_user)) %>
<% end %>

<!-- Plaid Link JS -->
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
  function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]').content;
  }

  async function relinkItem(itemId) {
    try {
      const res = await fetch('/mission_control/relink/' + itemId, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': getCsrfToken()
        },
        body: JSON.stringify({})
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert('Failed to get link token: ' + (err.error || res.statusText));
        return;
      }
      const data = await res.json();
      const handler = Plaid.create({
        token: data.link_token,
        onSuccess: async function(public_token, metadata) {
          try {
            await fetch('/mission_control/relink_success/' + itemId, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCsrfToken()
              },
              body: JSON.stringify({ public_token: public_token })
            });
          } catch (e) {
            console.warn('Failed to notify relink success:', e);
          }
          window.location.reload();
        },
        onExit: function(err, metadata) {
          if (err) {
            console.warn('Plaid Link exit:', err);
          }
        }
      });
      handler.open();
    } catch (e) {
      console.error('Failed to relink:', e);
      alert('Failed to connect to Plaid');
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const button = document.getElementById('plaid-link-button');
    if (!button) return;

    fetch('/plaid/link_token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': getCsrfToken()
      },
      body: JSON.stringify({})
    })
    .then(res => {
      if (!res.ok) throw new Error('Failed to get link token');
      return res.json();
    })
    .then(data => {
      const handler = Plaid.create({
        token: data.link_token,
        onSuccess: function(public_token, metadata) {
          fetch('/plaid/exchange_token', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': getCsrfToken()
            },
            body: JSON.stringify({
              public_token: public_token,
              institution: metadata.institution
            })
          })
          .then(res => res.json())
          .then(data => {
            console.log('Link success:', data);
            window.location.reload();
          })
          .catch(err => {
            console.error('Exchange failed:', err);
            alert('Failed to save account');
          });
        },
        onExit: function(err, metadata) {
          if (err) {
            console.warn('Plaid Link exit:', err);
          }
        }
      });
      button.onclick = function() {
        handler.open();
      };
    })
    .catch(err => {
      console.error('Link token failed:', err);
      button.disabled = true;
      button.textContent = 'Connection unavailable';
    });
  });
</script>
