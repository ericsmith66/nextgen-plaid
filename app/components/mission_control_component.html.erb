<div class="space-y-8">
  <!-- Actions -->
  <div class="flex flex-wrap gap-4">
    <%= button_to "üîÑ Sync Holdings", mission_control_sync_holdings_now_path, method: :post, class: "bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-semibold transition" %>
    <%= button_to "üí≥ Sync Transactions", mission_control_sync_transactions_now_path, method: :post, class: "bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-semibold transition" %>
    <%= button_to "üí∞ Sync Liabilities", mission_control_sync_liabilities_now_path, method: :post, class: "bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-semibold transition" %>
    <%= button_to "üöÄ Refresh Everything", mission_control_refresh_everything_now_path, method: :post, class: "bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition" %>
    <%= button_to "üí£ Nuke All Data", mission_control_nuke_path, method: :post, data: { confirm: "Delete ALL Plaid data? (cost history preserved)" }, class: "bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition" %>
  </div>

  <!-- Plaid Items -->
  <div>
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-2xl font-bold text-primary-400">Plaid Items (<%= @plaid_items.count %>)</h3>
      <div class="text-xs text-slate-500 font-mono">
        RAILS_ENV: <%= Rails.env %> | PLAID_ENV: <%= ENV["PLAID_ENV"] %>
      </div>
    </div>
    <% if @plaid_items.any? %>
      <div class="rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table role="table" class="table table-zebra w-full border border-base-300 bg-base-200 text-gray-200">
            <thead>
              <tr role="row" class="bg-base-300 text-white sticky top-0">
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Institution</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Status</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Accounts</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Holdings</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Last Synced</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Last Webhook</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @plaid_items.each do |item| %>
                <tr role="row" class="border-t border-base-300 hover:bg-base-300 focus-within:ring-2 focus-within:ring-primary">
                  <td role="cell" class="px-4 py-3 text-sm"><%= item.institution_name %></td>
                  <td role="cell" class="px-4 py-3 text-sm">
                    <span class="px-2 py-1 rounded text-sm <%= item.status == 'good' ? 'bg-green-600' : 'bg-red-600' %>">
                      <%= item.status.humanize %>
                    </span>
                  </td>
                  <td role="cell" class="px-4 py-3 text-sm"><%= item.accounts.count %></td>
                  <td role="cell" class="px-4 py-3 text-sm"><%= item.holdings.count %></td>
                  <td role="cell" class="px-4 py-3 text-sm text-gray-300">
                    <%= item.holdings_synced_at&.strftime("%Y-%m-%d %H:%M") || "Never" %>
                  </td>
                  <td role="cell" class="px-4 py-3 text-sm text-gray-300">
                    <%= item.last_webhook_at&.strftime("%Y-%m-%d %H:%M") || "Never" %>
                  </td>
                  <td role="cell" class="px-4 py-3 text-sm">
                    <div class="flex flex-col gap-4">
                      <!-- Standard Action -->
                      <div class="flex gap-1">
                        <%= button_to "Remove", mission_control_remove_item_path(item), method: :post, data: { confirm: "Remove this item and all associated data?" }, class: "btn btn-error btn-xs flex-1" %>
                        <% if item.status == 'needs_reauth' %>
                          <button type="button" onclick="relinkLiabilities(<%= item.id %>)" class="btn btn-info btn-xs flex-1">
                            Re-auth Liab
                          </button>
                        <% end %>
                      </div>

                      <!-- PRD 0050: Force Refresh Buttons -->
                      <div class="border-t border-base-300 pt-2 space-y-2">
                        <div class="text-[10px] uppercase font-bold text-slate-500 mb-1">Force Refresh</div>
                        <div class="flex flex-wrap gap-1">
                          <%= button_to "Txns", plaid_item_refresh_path(item, product: 'transactions'), method: :post, class: "btn btn-primary btn-xs", title: "Force /transactions/refresh" %>
                          <%= button_to "Holdings", plaid_item_refresh_path(item, product: 'holdings'), method: :post, class: "btn btn-primary btn-xs", title: "Force /investments/refresh" %>
                          <%= button_to "Liab", plaid_item_refresh_path(item, product: 'liabilities'), method: :post, class: "btn btn-primary btn-xs", title: "Force full liabilities sync" %>
                        </div>
                      </div>
                      
                      <!-- Webhook Testing Tools (Visible in all envs for now) -->
                      <div class="border-t border-base-300 pt-2 space-y-2">
                        <div class="text-[10px] uppercase font-bold text-slate-500 mb-1">Sandbox Webhooks</div>
                        <div class="flex flex-wrap gap-1">
                          <%= button_to "Fire Sync", mission_control_fire_webhook_path(item), params: { webhook_code: 'SYNC_UPDATES_AVAILABLE', webhook_type: 'TRANSACTIONS' }, method: :post, class: "btn btn-warning btn-xs", title: "Triggers SYNC_UPDATES_AVAILABLE" %>
                          <%= button_to "Fire Defs", mission_control_fire_webhook_path(item), params: { webhook_code: 'DEFAULT_UPDATE', webhook_type: 'HOLDINGS' }, method: :post, class: "btn btn-warning btn-xs", title: "Triggers DEFAULT_UPDATE" %>
                          <%= button_to "Set URL", mission_control_update_webhook_url_path(item), method: :post, class: "btn btn-ghost btn-xs border-base-300", title: "Sets Plaid Webhook URL" %>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="text-slate-400">No Plaid items yet.</p>
    <% end %>
  </div>

  <!-- Holdings -->
  <div>
    <h3 class="text-2xl font-bold text-primary-400 mb-4">Holdings (<%= @holdings.count %>)</h3>
    <% if @holdings.any? %>
      <div class="rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table role="table" class="table table-zebra w-full border border-base-300 bg-base-200 text-gray-200">
            <thead>
              <tr role="row" class="bg-base-300 text-white sticky top-0">
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Symbol</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Name</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-right text-sm font-semibold">Quantity</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-right text-sm font-semibold">Market Value</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Account</th>
              </tr>
            </thead>
            <tbody>
              <% @holdings.each do |holding| %>
                <tr role="row" class="border-t border-base-300 hover:bg-base-300 focus-within:ring-2 focus-within:ring-primary">
                  <td role="cell" class="px-4 py-3 text-sm font-semibold"><%= holding.symbol %></td>
                  <td role="cell" class="px-4 py-3 text-sm"><%= holding.name %></td>
                  <td role="cell" class="px-4 py-3 text-sm text-right"><%= number_with_delimiter(holding.quantity) %></td>
                  <td role="cell" class="px-4 py-3 text-sm text-right"><%= number_to_currency(holding.market_value) if holding.market_value %></td>
                  <td role="cell" class="px-4 py-3 text-sm"><%= holding.account&.name || holding.account&.account_id %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="text-slate-400">No holdings yet. Link a Plaid item and sync holdings.</p>
    <% end %>
  </div>

  <!-- Recent Transactions -->
  <div>
    <h3 class="text-2xl font-bold text-primary-400 mb-4">Recent Transactions (<%= @transactions.size %>)</h3>
    <% if @transactions.any? %>
      <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700">
        <%= render TransactionTableComponent.new(transactions: @transactions) %>
      </div>
      <div class="mt-4 text-right">
        <%= link_to "View all transactions ‚Üí", transactions_path, class: "link link-primary" %>
      </div>
    <% else %>
      <p class="text-slate-400">No transactions yet. Click "Sync Transactions" to fetch data.</p>
    <% end %>
  </div>

  <!-- Liabilities -->
  <div>
    <h3 class="text-2xl font-bold text-primary-400 mb-4">Liabilities</h3>
    <% liability_accounts = @accounts.select { |a| a.respond_to?(:apr_percentage) && (a.apr_percentage.present? || a.min_payment_amount.present?) } %>
    <% if liability_accounts.any? %>
      <div class="rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table role="table" class="table table-zebra w-full border border-base-300 bg-base-200 text-gray-200">
            <thead>
              <tr role="row" class="bg-base-300 text-white sticky top-0">
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Account</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-right text-sm font-semibold">Min Payment</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-right text-sm font-semibold">APR %</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Due Date</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-center text-sm font-semibold">Overdue?</th>
              </tr>
            </thead>
            <tbody>
              <% liability_accounts.each do |account| %>
                <tr role="row" class="border-t border-base-300 hover:bg-base-300 focus-within:ring-2 focus-within:ring-primary">
                  <td role="cell" class="px-4 py-3 text-sm"><%= account.name || account.account_id %></td>
                  <td role="cell" class="px-4 py-3 text-sm text-right"><%= number_to_currency(account.min_payment_amount) if account.min_payment_amount %></td>
                  <td role="cell" class="px-4 py-3 text-sm text-right"><%= account.apr_percentage ? "#{account.apr_percentage}%" : '-' %></td>
                  <td role="cell" class="px-4 py-3 text-sm"><%= account.next_payment_due_date || '-' %></td>
                  <td role="cell" class="px-4 py-3 text-sm text-center">
                    <%= account.is_overdue ? '<span class="text-red-400">‚ö†Ô∏è YES</span>'.html_safe : '<span class="text-green-400">No</span>'.html_safe %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="text-slate-400">No liabilities yet. Click "Sync Liabilities" to fetch data.</p>
    <% end %>
  </div>

  <!-- Sync Logs (PRD UI-3) -->
  <div>
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-2xl font-bold text-primary-400">Sync Logs (<%= @sync_logs.total_count %>)</h3>
      <% if @webhook_logs.any? %>
        <div class="dropdown dropdown-end">
          <label tabindex="0" class="btn btn-ghost btn-xs text-slate-500 underline">Recent Webhooks</label>
          <div tabindex="0" class="dropdown-content z-[1] menu p-4 shadow bg-base-300 rounded-box w-96 border border-base-100">
            <h4 class="font-bold mb-2 text-sm">Last 10 Webhooks</h4>
            <ul class="space-y-2 text-[11px]">
              <% @webhook_logs.each do |w| %>
                <li class="border-b border-base-100 pb-1 list-none">
                  <div class="flex justify-between">
                    <span class="font-mono text-primary-300"><%= w.event_type %></span>
                    <span class="<%= w.status == 'success' ? 'text-green-400' : 'text-red-400' %> uppercase font-bold"><%= w.status %></span>
                  </div>
                  <div class="text-slate-400"><%= w.created_at.strftime("%H:%M:%S") %> | <%= w.plaid_item&.institution_name %></div>
                </li>
              <% end %>
            </ul>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Filters -->
    <div class="mb-6 bg-slate-800 p-4 rounded-lg border border-slate-700">
      <%= form_with url: mission_control_path, method: :get, local: true, class: "grid grid-cols-1 md:grid-cols-4 gap-4" do |f| %>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Job Type</label>
          <%= f.select :job_type,
              options_for_select([
                ["All Types", ""],
                ["Holdings", "holdings"],
                ["Transactions", "transactions"],
                ["Liabilities", "liabilities"]
              ], params[:job_type]),
              {},
              class: "w-full bg-slate-700 border border-slate-600 text-white rounded-md p-2 focus:ring-primary-500 focus:border-primary-500" %>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Status</label>
          <%= f.select :status,
              options_for_select([
                ["All Statuses", ""],
                ["Success", "success"],
                ["Failure", "failure"],
                ["Started", "started"]
              ], params[:status]),
              {},
              class: "w-full bg-slate-700 border border-slate-600 text-white rounded-md p-2 focus:ring-primary-500 focus:border-primary-500" %>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Start Date</label>
          <%= f.date_field :start_date, value: params[:start_date], class: "w-full bg-slate-700 border border-slate-600 text-white rounded-md p-2 focus:ring-primary-500 focus:border-primary-500" %>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">End Date</label>
          <%= f.date_field :end_date, value: params[:end_date], class: "w-full bg-slate-700 border border-slate-600 text-white rounded-md p-2 focus:ring-primary-500 focus:border-primary-500" %>
        </div>

        <div class="md:col-span-4 flex gap-3">
          <%= f.submit "Apply Filters", class: "bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-6 rounded cursor-pointer transition" %>
          <% if params[:job_type].present? || params[:status].present? || params[:start_date].present? || params[:end_date].present? %>
            <%= link_to "Clear Filters", mission_control_path, class: "bg-slate-600 hover:bg-slate-500 text-white font-medium py-2 px-6 rounded transition" %>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Logs Table -->
    <% if @sync_logs.any? %>
      <div class="rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table role="table" class="table table-zebra w-full border border-base-300 bg-base-200 text-gray-200">
            <thead>
              <tr role="row" class="bg-base-300 text-white sticky top-0">
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Time</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Institution</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Job Type</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Status</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Error</th>
                <th scope="col" role="columnheader" aria-sort="none" class="px-4 py-3 text-left text-sm font-semibold">Job ID</th>
              </tr>
            </thead>
            <tbody>
              <% @sync_logs.each do |log| %>
                <tr role="row" class="border-t border-base-300 hover:bg-base-300 focus-within:ring-2 focus-within:ring-primary">
                  <td role="cell" class="px-4 py-3 text-sm text-gray-300">
                    <%= log.created_at.strftime("%Y-%m-%d %H:%M:%S") %>
                  </td>
                  <td role="cell" class="px-4 py-3 text-sm">
                    <%= log.plaid_item&.institution_name || "N/A" %>
                  </td>
                  <td role="cell" class="px-4 py-3 text-sm">
                    <span class="px-2 py-1 rounded text-xs bg-slate-600">
                      <%= log.job_type %>
                    </span>
                  </td>
                  <td role="cell" class="px-4 py-3 text-sm">
                    <% if log.status == "success" %>
                      <span class="px-2 py-1 rounded text-xs bg-green-600">‚úì Success</span>
                    <% elsif log.status == "failure" %>
                      <span class="px-2 py-1 rounded text-xs bg-red-600">‚úó Failure</span>
                    <% elsif log.status == "started" %>
                      <span class="px-2 py-1 rounded text-xs bg-blue-600">‚ü≥ Started</span>
                    <% else %>
                      <span class="px-2 py-1 rounded text-xs bg-slate-600"><%= log.status %></span>
                    <% end %>
                  </td>
                  <td role="cell" class="px-4 py-3 text-sm text-gray-300 max-w-xs truncate">
                    <%= log.error_message || "-" %>
                  </td>
                  <td role="cell" class="px-4 py-3 text-sm text-gray-400 font-mono text-xs">
                    <%= log.job_id&.first(8) || "-" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <div class="mt-6 flex justify-center">
        <%= helpers.paginate @sync_logs %>
      </div>
    <% else %>
      <p class="text-slate-400">No sync logs found. Run a sync operation to see logs here.</p>
    <% end %>
  </div>
</div>
