### PRD 0030: Planning Phase for CWA

**Overview**: Add Planner (ENTJ) phase to break PRDs into micro-tasks via shared context/tool calls; handoff from Coordinator to Planner before CWA. Ties to vision for structured learning in internship.

**Requirements**:
1) **Planner Registration**: Register Planner agent (ENTJ persona, tools: `[TaskBreakdownTool]` for micro-task generation).
2) **Planning Flow**: Handoff → Planner parses PRD and outputs `context[:micro_tasks]` as an array of objects:
   - `id` (String)
   - `title` (String)
   - `files` (Array of String; optional)
   - `commands` (Array of String; optional; must be allowlist-friendly)
   - `risk` (String; e.g., low/med/high)
   - `estimate` (String; e.g., "30m")
3) **Integration**: Update runner for Planner phase (pre-CWA); serialize `micro_tasks` to JSON and pass to CWA.
4) **Resolution**: If complex, loop back for feedback; `max_turns=3`.
5) **Non-Functional**: Breaks into 5–10 tasks; context under 10k tokens.
6) **Rails Guidance**: Tool as subclass (`TaskBreakdownTool.run(prd_text) → array`); inject into `AiWorkflowService`.

**Sequencing Note**: This PRD may move earlier (right after 0050B) if “planning-before-tools” becomes mandatory.

**Architectural Context**: Local Ollama; RAG includes PRD MDs in context.

**Acceptance Criteria**:
- Handoff with PRD → Planner outputs `micro_tasks` object array in context.
- Complex PRD → loops for refinement.
- Micro-tasks persist for CWA handoff.
- Output: JSON array verifiable in console.

**Test Cases**:
- Unit: MiniTest for tool (mock input, assert array format).
- Integration: MiniTest/VCR for phase (cassette Planner prompt; assert context updated). Edge: Large PRD → truncation handled.

**Workflow**: Junie: Pull from main, `git checkout -b feature/prd-50e-planning-phase`. Read `<project root>/knowledge_base/prds/prds-junie-log/junie-log-requirement.md` for logging. Ask questions (e.g., “Micro-task granularity?”) and build a plan in `junie-log.md` before coding. Use Claude Sonnet 4.5 default in RubyMine. Implement, test, commit green. Push for review.
