### PRD 0040: Impl/Test/Commit with CWA

**Overview**: Integrate CWA (INTP persona) into gem as agent with tool calling for implementation/test/commit (e.g., safe shell for `rails g`, `git commit`); enable handoffs from Coordinator for code generation. Ties to vision by automating safe code paths post-PRD.

**Requirements**:
1) **CWA Registration**: Register CWA agent in initializer (persona: INTP; tools: `[SafeShellTool, GitTool]`).
2) **Out-of-Process Sandbox**: All tool execution runs out-of-process inside `tmp/agent_sandbox/` (subprocess + restricted working dir). No tool runs in-process.
3) **Tool Calling**: Define custom tools as `AiAgents::Tool` subclasses with strict allowlists:
   - `SafeShellTool.run(cmd)` allowlist regex (deny-by-default; no `rm`, no network, no secrets)
   - `GitTool.*` limited to local operations only
4) **Dry-Run First**: Start with `dry_run=true` default where tools return the planned command list without executing; execution requires explicit human enable.
5) **Impl Flow**: Handoff from Coordinator → CWA proposes and/or executes steps via tool calls, runs `bundle exec rake test` (+ `rubocop` if present), and commits **locally** only when green.
6) **Human-in-the-Loop Git Policy**: AI may create a local branch + commits; human is required to push/merge. No remote credentials.
7) **Non-Functional**: Commits only if green; tools local-only; max tool calls=10 per turn; max retries=2.
8) **Rails Guidance**: Update `AiWorkflowService` with CWA-specific handoff. Tests use deterministic stubs; audit every tool call to `events.ndjson`.

**Architectural Context**: Local Ollama for CWA prompts; RAG context includes nav tree Mermaid. Rails for tool wrappers; no new DB.

**Acceptance Criteria**:
- Handoff to CWA → tool calls generate model, run tests, commit if green.
- Failure → retry or escalate log.
- Whitelist: Blocks unsafe cmds (e.g., `rm`).
- Commit: Feature branch created and committed **locally** if green; pushing/merging is human-only.
- Logs: Full tool output in `agent_logs/`.

**Test Cases**:
- Unit: MiniTest for tools (mock exec, assert whitelist blocks).
- Integration: MiniTest/VCR for handoff (cassette CWA prompt; assert commit exists). Edge: Red tests → no commit; max calls → halt.

**Workflow**: Junie: Pull from main, `git checkout -b feature/prd-50c-cwa-impl`. Read `<project root>/knowledge_base/prds/prds-junie-log/junie-log-requirement.md` for logging. Ask questions (e.g., “Tool whitelist scope?”) and build a plan in `junie-log.md` before coding. Use Claude Sonnet 4.5 default in RubyMine. Implement, test, commit green. Push for review.

---

### Notes (Jan 2026): sandbox runner reliability fixes

- **Observed failure mode**: `git worktree add` can fail when the requested branch is already checked out in a previous sandbox worktree (git restriction: one branch per worktree).
- **Observed diagnostics gap**: `script/agent_sandbox_runner` returns inner command results as JSON on stdout; without parsing that JSON, callers can lose the *real* `stderr` and see empty error messages.
- **Mitigations implemented**:
  - Add **timeouts** and a **non-interactive git env** inside `script/agent_sandbox_runner` to avoid indefinite hangs.
  - Parse the runner’s JSON stdout in `AgentSandboxRunner.run` so callers receive the inner `{status, stdout, stderr}`.
  - When a branch is already in use by another worktree, create a **unique per-correlation sandbox branch** from the requested branch and add the worktree via `git worktree add -b ...`.
