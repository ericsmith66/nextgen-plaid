### PRD 0050A: Persona Setup & Console Handoffs

**Overview**: Spike + baseline implementation. Validate `chatwoot/ai-agents` (`ai-agents`, `require 'agents'`) in this Rails app with a minimal, thread-safe runner that can perform a simple hub-and-spoke handoff (User prompt → SAP → Coordinator) while preserving a shared `context` hash and writing run artifacts. Prove multi-provider viability via SmartProxy (OpenAI-compatible `/v1/chat/completions`) across Ollama, Grok, and Claude.

**Requirements**:
1) **Gem Install & Config**: `bundle add ai-agents` and initialize with `require 'agents'`. Create `config/initializers/ai_agents.rb` that:
   - registers agents: User (ENTP), SAP (INTJ), Coordinator (ENFJ), Planner (ENTJ) (tools empty in v1)
   - configures a custom provider adapter (extends `AiAgents::Provider`) that calls SmartProxy `/v1/chat/completions`
   - defaults: model `llama3.1:70b` (overrideable to `llama3.1:8b` via ENV)
2) **Persona Registration Source**: Do **not** parse Markdown at runtime. Source personas from a dedicated config (e.g., `knowledge_base/personas.yml`) generated from `knowledge_base/vision.md`.
3) **Shared Context Schema**: Use a stable `context` hash with:
   - `correlation_id` (`SecureRandom.uuid`)
   - `state` (`in_progress` initially)
   - `ball_with` (set by agent decision; human override allowed)
   - `turns_count`, `feedback_history`, `artifacts`, `micro_tasks`
4) **Console/Rake Runner**: Add `rake ai:run_request[prompt]` which runs a 2-agent chain:
   - SAP receives the prompt and either answers or emits an explicit handoff directive.
   - Coordinator receives SAP’s output and sets `ball_with`.
   Print concise console logs including `correlation_id` and `Ball with: <X>`.
5) **Multi-Provider Spike**: Demonstrate the chain runs against **three** SmartProxy-backed providers:
   - Ollama (default)
   - Grok (OpenAI-ish with minor deviations)
   - Claude
   Provider selection via ENV/config.
6) **Persistence & Artifacts**: Always write file artifacts:
   - `agent_logs/ai_workflow/<correlation_id>/run.json`
   - `agent_logs/ai_workflow/<correlation_id>/events.ndjson`
   Allow a minimal DB model `AiWorkflowRun` **if** needed for resumability/UI.
7) **Guardrails (v1)**: `max_turns=3` for spike; local-only execution; invalid/empty prompt halts with a clear error log.
8) **Rails Guidance**: Implement `AiWorkflowService` in `app/services` and inject optional RAG JSON (e.g., `FinancialSnapshotJob`) into `context` as available.

**Architectural Context**: Builds on Rails MVC with Devise/RLS for auth/privacy; plaid-ruby patterns for services. Use static MDs for RAG (e.g., `0_AI_THINKING_CONTEXT.md` in context hash). Local Ollama via SmartProxy; no vector DB. Defer UI—focus console for atomic testing.

**Acceptance Criteria**:
- `ai-agents` installs and initializer boots in Rails (`require 'agents'`) without errors.
- `rake ai:run_request["Generate PRD"]` prints:
  - `correlation_id`
  - SAP output
  - a handoff event (SAP → Coordinator)
  - `Ball with: <X>`
- Shared `context` persists across the handoff and is written to `run.json`.
- Spike proof: Successful 2-agent chain works for **Ollama**, **Grok**, and **Claude** via SmartProxy `/v1/chat/completions` (provider selected by config/ENV).
- Invalid/empty prompt halts with a guardrail error (no provider call).
- Admin-gated execution is defined (at minimum: explicit environment/allowlist; no accidental prod execution).
- Test strategy is deterministic (no live network) and new runner/service layer reaches ~80% coverage.

**Test Cases**:
- Unit: MiniTest for `AiWorkflowService.run` (assert handoff + context mutation + artifact writes).
- Unit: Provider adapter tests using `WebMock` stubs against SmartProxy test port (`3002`), asserting request shape and response parsing.
- Task: MiniTest for `ai:run_request` (asserts output includes `correlation_id` + `Ball with:`; stubs network).
- Edge: max turns exceeded → escalates/halts with banner and writes event; empty prompt → guardrail error.

**Workflow**: Junie: Pull from main, `git checkout -b AGENT-05-Spike`. Read `<project root>/knowledge_base/prds/prds-junie-log/junie-log-requirement.md` for logging. Build a plan in `junie-log.md` before coding. Use Claude Sonnet 4.5 default in RubyMine. Implement, test with deterministic `WebMock` stubs (defer live recordings unless stable), commit only if green. Push branch for review.
