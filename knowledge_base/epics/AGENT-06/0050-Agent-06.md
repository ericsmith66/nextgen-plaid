### PRD 0050: Workflow Integration & Hybrid Handoff
**Overview**: Integrate CWA into Epic 5 ai-agents workflow for hybrid handoffs (e.g., receive micro-tasks from Planner, draft impl, hand back drafts for human review/commit staging); enable deprecation of Junie by making CWA the primary code gen agent. This completes CWA as a collaborative, traceable implementer, tying to vision for AI-assisted stewardship in the family-office platform.

**Requirements**:
1) **Workflow Handoffs**: Use ai-agents route_to for CWA to receive from Planner/Coordinator (context hash with micro_tasks, correlation_id); CWA processes (impl/debug from 0060C/D), updates context (artifacts: drafts/files, state: awaiting_review); hands back to Coordinator with "ball_with=Human" on completion/escalation.
2) **Hybrid Mode**: CWA drafts code/tests via tools, stages local commits (git add/commit --no-push); human reviews via console/UI (e.g., git diff output in logs); no auto-merge—escalate for approval.
3) **Integration with Gem**: Add CWA-specific callbacks (after_impl: handoff drafts, after_debug: update checkpoints); persist full workflow in AiWorkflowRun model (jsonb for context/logs) or run.json/events.ndjson.
4) **Deprecation Path for Junie**: Route Junie-like tasks (e.g., code gen) to CWA via gem runner; log migration (e.g., "Deprecating Junie: Using CWA for [task]").
5) **Non-Functional**: Handoffs <10s; support 5-micro-task chains; local-only; admin-gate any console access.
6) **Rails Guidance**: Update AiWorkflowService with .handoff_to_cwa(method); no new migrations (use existing AiWorkflowRun); branch naming feature/prd-<correlation_id>; dry-run v1 for handoffs (simulate drafts).

**Architectural Context**: Builds on ai-agents CWA registration (tools/callbacks/persona); handoffs update context schema (add debug_history to feedback_history if needed). Rails MVC for services; local Ollama/Grok/Claude via SmartProxy; RAG via context (include nav tree, PRODUCT_REQUIREMENTS.md). Privacy: No external handoffs; RLS on model. Defer full automation—focus hybrid for safety.

**Acceptance Criteria**:
- Planner handoff micro-tasks → CWA receives, implements/debugs, hands back drafts with awaiting_review state.
- Drafts staged: Local commit exists (git log shows), no push; artifacts list files/diffs.
- Escalation: Debug failure post-retries → ball_with=Human, blocked state.
- Junie deprecation: Legacy prompt → routes to CWA, logs migration note.
- Dry-run: Simulates handoff without real impl.
- Logs: Full 12-sections updated across workflow.
- Resumability: Interrupted handoff resumes from context checkpoints.

**Test Cases**:
- Unit: MiniTest for .handoff_to_cwa (mock gem route_to, assert context updated with drafts/artifacts).
- Integration: MiniTest/VCR for full workflow (cassette multi-agent chain; assert handoff completes, drafts committed locally, escalation on failure). Edge: No micro-tasks → immediate escalate; human override → updates ball_with.

**Workflow**: Junie: Pull from main, git checkout -b feature/prd-60e-workflow-handoff. Read <project root>/knowledge_base/prds/prds-junie-log/junie-log-requirement.md for logging. Ask questions (e.g., "Handoff escalation triggers?") and build a plan in junie-log.md before coding. Use Claude Sonnet 4.5 default in RubyMine. Implement, test with MiniTest/VCR using real SmartProxy, commit only if green. Push branch for review.

