### PRD 0030: MCP-Like Tools Integration (Read-only v1)
**Overview**: Extend CWA toolkit with MCP-like **read-only** tools for project search, code analysis, and version control, integrated as ai-agents tool subclasses. This enhances CWA’s ability to reason over the repo during micro-task implementation, while keeping a strict safety boundary.

**Requirements**:
1) **MCP Tools Registration (v1)**: Add **read-only** tools to CWA agent:
   - ProjectSearchTool (grep/tree for file search)
   - VcTool (git log/status/diff)
   - CodeAnalysisTool (rubocop output only)
   Tools are `AiAgents::Tool` subclasses under `app/tools/`.
2) **Tool Functionality (v1)**:
   - ProjectSearchTool.search(query) → grep results in repo (allowlist dirs `app/`, `lib/`, `test/`)
   - CodeAnalysisTool.analyze(file) → `rubocop` output (no auto-correct)
   - VcTool.get_diff(branch) → `git diff` against `main` (read-only)
3) **Integration with Gem**: Tools callable from CWA prompts (structured args e.g., {file: path, query: string}); outputs JSON for context update (e.g., {results: array, errors: []}); handoff back if analysis blocks impl.
4) **Guardrails**:
   - deny-by-default allowlist; **no network**
   - out-of-process sandbox (`tmp/agent_sandbox/` subprocess, 30s timeout)
   - dry-run supported (return “would run …”)
   - escalate on non-allowlisted command/tool misuse
5) **Non-Functional**: Tools local-only, no network; <10s execution; support 100-file repos without lag; logs tool calls in 12-section template (execute/analysis sections).
6) **Defer runtime/schema intel**:
   - Defer `RuntimeTool` and `RailsIntelTool` until sandbox constraints are proven.
   - For v1 schema intel, prefer parsing `db/schema.rb` or static metadata.

**Architectural Context**: Builds on Epic 5 ai-agents: Tools in CWA registration; handoffs update context schema (artifacts: tool outputs). Rails MVC for tools; local Ollama/Grok/Claude via SmartProxy; RAG via context (include 0_AI_THINKING_CONTEXT.md). Privacy: No external calls; RLS on any runtime inspect. Defer advanced search—use basic grep/tree.

**Acceptance Criteria**:
- CWA with MCP tools registered without errors.
- Search tool → returns grep results for query in `app/`; blocks non-allowlisted dirs.
- Dry-run: Returns "would run: grep -r 'def' app/" without exec.
- VC tool: git diff output for branch, no write ops.
- Code analysis tool: returns `rubocop` output only (no auto-correct).
- Escalation: Invalid cmd → logs failure, hands back to Coordinator.
- Logs: Tool sections populated in events.ndjson/run.json.

**Test Cases**:
- Unit: MiniTest for ProjectSearchTool.search (mock system call, assert grep output parsed to JSON).
- Integration: MiniTest with deterministic stubs (no VCR required) asserting context updated with tool outputs and logs match template. Edge: Non-allowlisted cmd → raises; timeout → escalates.

**Workflow**: Junie: Pull from main, git checkout -b feature/prd-60c-mcp-tools. Read <project root>/knowledge_base/prds/prds-junie-log/junie-log-requirement.md for logging. Ask questions (e.g., "Whitelisted cmds details?") and build a plan in junie-log.md before coding. Use Claude Sonnet 4.5 default in RubyMine. Implement, test with MiniTest/VCR using real SmartProxy, commit only if green. Push branch for review.

Note: Prefer deterministic stubs (`WebMock`) for tool tests; use VCR only when a live SmartProxy call is essential and stable.

