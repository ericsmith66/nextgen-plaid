### PRD 0010: CWA Persona & Safe Shell Toolkit
**Overview**: Register Code Writing Agent (CWA) as an agent in chatwoot/ai-agents gem with INTP persona, set up safe shell toolkit for basic code gen tasks (e.g., rails g, rake), and enable handoffs from Planner/Coordinator. This establishes CWA as a safe, tool-equipped implementer for PRD micro-tasks, tying to vision by automating wealth management code paths in a controlled, local environment for family-office privacy.

**Requirements**:
1) **CWA Registration**: In config/initializers/ai_agents.rb, register CWA via AiAgents::Agent.new(name: "CWA", persona: extract INTP desc from knowledge_base/personas.yml, instructions: "Implement micro-tasks safely: plan, generate code/tests, debug, stage commits if green—human push/merge"). Set provider to SmartProxy wrapper (HTTP to localhost:3001, default llama3.1:70b, overrides for Grok/Claude via ENV).
   - **Claude**: ⏳ not yet supported in SmartProxy; treat as future.
   - **Model discovery**: Prefer SmartProxy `GET /v1/models` as source of truth; ENV fallback.
2) **Safe Shell Toolkit**: Define 2 core tools as AiAgents::Tool subclasses (app/tools/safe_shell_tool.rb, git_tool.rb): SafeShellTool.run(cmd) with deny-by-default allowlist regex (e.g., /^rails g/, /^bundle exec rake test/). **No `rm` in v1**; no network. Execute in out-of-process subprocess (`tmp/agent_sandbox/` with restricted env/dir, timeout 30s); GitTool.stage_and_commit(message) if tests green (git add/commit local only, no push; dry-run v1 returns commands).
3) **Handoff Integration**: Use gem's route_to for receiving micro-tasks from Planner (context hash per Epic 5 schema: micro_tasks array, correlation_id); CWA processes one micro-task per turn, updates context (e.g., artifacts: paths to generated files/logs).
4) **Guardrails**: Max tool calls=5 per turn; custom allowlist (app/tests/ dirs only, no config/secrets); escalate failures to Coordinator with "ball_with=Human" metadata; log all actions to events.ndjson.
5) **Non-Functional**: Local-only execution; support 5k token prompts <30s; thread-safe for Rails; admin-gate any rake/console access.
6) **Rails Guidance**: No new models/migrations (use AiWorkflowRun from Epic 5 for context); service AiCodeWriterService (app/services) for tool wrappers; whitelist: /^rails g (model|controller|migration)/, /^rake test/, /^git (add|commit)/; sandbox: spawn subprocess with Dir.chdir('tmp/agent_sandbox/'), capture stdout/stderr.

**Architectural Context**: Aligns with Rails MVC: Tools as subclasses in app/tools/; handoffs via AiWorkflowService from Epic 5; local Ollama/Grok/Claude via SmartProxy (OpenAI-compatible endpoint, adapt Grok modified); RAG via context hash (include nav tree Mermaid, 0_AI_THINKING_CONTEXT.md). Defer vector DB—use static MDs/JSON snapshots. Privacy: RLS/attr_encrypted on any data; disclaimers in logs ("Educational simulation only").

**Safety Policy**: Out-of-process sandbox; deny-by-default allowlist; no network beyond SmartProxy; AI local commits only; human push/merge.

**Acceptance Criteria**:
- Initializer registers CWA without errors; persona/instructions load from personas.yml.
- Handoff with micro-task (e.g., "Add Position model") → CWA tool calls generate migration/model, logs to events.ndjson.
- Whitelist blocks unsafe cmd (e.g., rm) → escalates with error.
- Dry-run: Returns "would run: rails g model Position..." without execution.
- Git tool: Stages/commits green changes locally (branch feature/prd-xyz), no push.
- Context updates: Artifacts array includes generated file paths.
- Timeout/escalate: Long cmd → halts gracefully, sets ball_with=Human.
- Token limit: Handles 2k prompt micro-task without truncation.

**Test Cases**:
- Unit: MiniTest for SafeShellTool.run (mock subprocess, assert whitelist allows rails g, blocks rm; assert timeout raises).
- Integration: MiniTest/VCR for handoff (cassette CWA prompt via SmartProxy with Ollama/Grok/Claude; assert generated files exist, commit staged, logs match template). Edge: Red whitelist → no exec; max calls → halt.

**Workflow**: Junie: Pull from main, git checkout -b feature/prd-60a-cwa-toolkit. Read <project root>/knowledge_base/prds/prds-junie-log/junie-log-requirement.md for logging. Ask questions (e.g., "Confirm whitelist regex?") and build a plan in junie-log.md before coding. Use Claude Sonnet 4.5 default in RubyMine. Implement, test with MiniTest/VCR using real SmartProxy, commit only if green (no errors in logs). Push branch for review.

