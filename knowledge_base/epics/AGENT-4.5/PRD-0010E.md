# PRD 0010E: Bare Layout & Input (vertical stream, pinned footer/send, auto-scroll JS) + SapAgent Wiring

**Overview**: Create a minimal chat UI page at `/admin/sap_collaborate` for SAP interactions, featuring a vertical message stream, bottom-pinned input form, auto-scrolling JS, and direct wiring to `SapAgent` for submitting questions and streaming answers via Turbo Streams (ActionCable-backed). This is the “bare-metal” baseline for SAP oversight: ask a question, see a single assistant bubble update over time until completion.

## Requirements

### 1) Bare Layout & Stream
Use ERB view (`admin/sap_collaborate/index.html.erb`) with Tailwind CSS for a full-height vertical container (`#chat-stream.flex.flex-col`). Render messages as simple div bubbles (user: right-aligned blue, assistant: left-aligned gray) via partial (`_message.html.erb`). Stub future gear menu as empty div.

### 2) Pinned Input & Send
Footer form with textarea (pinned via `position: sticky`, min-height 100px) and submit button ("Send"). On submit, POST to `/admin/sap_collaborate/ask` → clear input, append user message to stream.

### 3) Auto-Scroll JS
Stimulus controller (`chat_controller.js`) with `connect()` for initial `scrollIntoView` on the last message; `MutationObserver` on `#chat-stream` to scroll on appends/replaces. No mobile keyboard overlap handling for v1.

### 4) Turbo Streams Wiring (ActionCable baseline)
Use Turbo Streams for real-time appends/replaces. No polling fallback for v1.

**Stream name (required convention)**: all Turbo broadcasts for a run must be scoped to a per-run stream named `"sap_run_#{sap_run_id}"`.

**Implementation gotchas / required infra notes (so streaming works in dev)**:

- **ActionCable must be mounted** at `GET /cable` (e.g., `mount ActionCable.server => "/cable"`). If `/cable` isn’t mounted, the browser will never open a websocket and messages will only update on refresh.
- **Layouts must include** `action_cable_meta_tag` so the client knows where to connect.
- **Hotwire must actually boot** on the page:
  - The importmap `application` entrypoint must import `@hotwired/turbo-rails` and `controllers` (Stimulus).
  - If Turbo isn’t booted, `<turbo-cable-stream-source>` elements will render but will not connect/subscribe.
- **Development ActionCable adapter must support cross-process broadcasting**.
  - The `async` adapter only broadcasts within a single process.
  - Because `SapAgentJob` runs in a separate background worker process, dev must use something cross-process (this repo uses `solid_cable`).

- Initial message render: append bubbles to `#chat-stream`.
- Streaming updates: update the *existing* assistant bubble using Turbo `replace` (not append) to avoid duplication.

Broadcasting should live in the model callbacks for simplicity:

- `after_create_commit`: `broadcast_append_to` the run/channel.
- `after_update_commit`: `broadcast_replace_to` targeting the assistant message DOM id.

### 5) SapAgent Connection
Controller action `ask` (POST) → validate input, create:

- a user `SapMessage` with the submitted prompt
- an assistant `SapMessage` created immediately with `content: "Thinking..."` (or empty)

Then enqueue `SapAgentJob.perform_later(sap_run_id, assistant_message_id, prompt)`.

**Job input contract (deterministic)**: enqueue the job with the prompt string explicitly:

- `SapAgentJob.perform_later(sap_run_id, assistant_message_id, prompt)`

The job must not query the DB to “reconstruct” the prompt from prior messages.

`SapAgentJob` owns the streaming loop:

- Call `AiFinancialAdvisor.ask(prompt)` routed through SmartProxy (mandatory), not direct Ollama.
- Accumulate chunks in-memory and periodically `update!` the assistant message:
  - roughly every ~500 chars or ~500ms, plus a final `update!` at the end
- Errors update the assistant bubble content to include an error message (and an ID if available).

### 6) Non-Functional
Page loads in <2s; stream chunks every 1-2s; support 10k+ token responses without lag. Admin-only (before_action :authenticate_user!, :authorize_admin).

For local development:

- Ensure the `cable` database is created/migrated when using `solid_cable`.

### 7) alexrudall Gist Direction
Copy the gist’s structure and simplify further:

- One DB record per bubble (not per chunk): create one assistant message and update it as content grows.
- Streaming loop in the job.
- Broadcasting in the model.
- Key adaptation: use `broadcast_replace_later_to` for updates (don’t append on update).

Ignore OpenAI-specific params; map to Ollama via `AiFinancialAdvisor` and route all calls through SmartProxy (ports 3001 dev / 3002 test).

## Architectural Context
Aligns with Rails MVC: `SapCollaborateController` for actions (`ask`); new `SapRun` model (tracks session) and `SapMessage` (role enum, content). No per-chunk tables. Use plaid-ruby patterns for services (`SapAgentService`/`AiFinancialAdvisor`) and route all LLM requests via SmartProxy. Local-only: Ollama on-premises, no cloud. Defer vector DB—use static MD files in RAG.

## Acceptance Criteria
- Load /admin/sap_collaborate → empty stream, pinned input visible at bottom.
- Type question → submit → user bubble appends right-aligned, "Thinking..." left-aligned.
- SapAgent processes → chunks stream into the same assistant bubble via Turbo replaces, auto-scrolls to bottom.
- Full response completes → final bubble markdown-rendered (e.g., bold/lists).
- Error (e.g., Ollama down) → red bubble with "Error: [msg] (ID: xyz)".
- Mobile: Basic functionality (no overlap fixes).
- Admin-gate: Non-admins 403 on access.

## Test Cases
- **Unit**: MiniTest for `SapAgentService` / `AiFinancialAdvisor.ask` (mock HTTP to SmartProxy, assert chunk yields).
- **Job**: MiniTest for `SapAgentJob` chunk accumulation/write cadence (assert assistant message content accumulates; assert broadcast replace calls happen).
- **Integration**: MiniTest with VCR cassettes for end-to-end SmartProxy interactions; assert final `SapMessage.content` equals the accumulated content. Edge: Empty prompt → validation error; long response (>5k tokens) → no truncation.

## Workflow
Junie: Pull from main, git checkout -b feature/agent-4.5-bare-chat-sap. Read <project root>/knowledge_base/prds/prds-junie-log/junie-log-requirement.md for logging. Ask questions (e.g., "Confirm Redis setup in config/cable.yml for local dev?") and build a plan in junie-log.md before coding. Use Claude Sonnet 4.5 default in RubyMine. Implement, test with MiniTest/VCR using real SmartProxy (cassettes capture live runs), commit only if green (no errors in logs). Push branch for review.

## Next Steps
Assign to Junie now? Revise gist adaptations (e.g., skip multi-response n>1)?
